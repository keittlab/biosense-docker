#!/bin/bash

# Load SDM parameters
function loadparams() {
    source $SDMPT/etc/sdm/sdm-readparams
}

# Get the phase (0, 1, or post-install) and arguments
phase=$1
pfx="$(basename $0)"
args="$2"
vldargs=""
loadparams

if [ "$phase" == "0" ]; then
    #
    # In Phase 0 all references to directories in the image
    # must be preceded by $SDMPT
    #
    logtoboth "* Plugin $pfx: Start Phase 0"
    logfreespace "at start of $pfx Phase 0"
    plugin_getargs $pfx "$args" "$vldargs"

    logfreespace "at end of $pfx Phase 0"
    logtoboth "* Plugin $pfx: Complete Phase 0"

elif [ "$phase" == "1" ]; then
    #
    # Phase 1 (in nspawn)
    #
    logtoboth "* Plugin $pfx: Phase 1"
    plugin_getargs $pfx "$args" "$vldargs"
    logfreespace "at start of $pfx Phase 1"
    
    # Since we have autologin, this will set an autologout 
    # This gives you 10 minutes to access the system after reboot
    # This will help with lost password, although it does give
    # others an easy way to access the system by simply restarting it
    # This is system-wide for all regular user accounts
    # You can disable by typing "unset TMOUT"
    echo "TMOUT=600" > /etc/profile.d/autologout.sh && \
    echo "export TMOUT" >> /etc/profile.d/autologout.sh && \
    chmod +x /etc/profile.d/autologout.sh && \
    logtoboth "Automatic shell logout set to 10 minutes."

    # Need to assign strong password to biosense account

    logfreespace "at end of $pfx Phase 1"
    logtoboth "* Plugin $pfx: Phase 1 completed"

elif [ "$phase" == "post-install" ]; then
    #
    # Post-install edits
    #
    logtoboth "* Plugin $pfx: Phase post-install"
    plugin_getargs $pfx "$args" ""
    logfreespace "at start of $pfx Phase post-install"

    logfreespace "at end of $pfx Custom Phase post-install"
    logtoboth "* Plugin $pfx: Phase post-install Completed"
fi

echo "done."
exit 0
