#!/usr/bin/env python3

import os
import time
import logging
from logging.handlers import RotatingFileHandler
import subprocess
from datetime import datetime

# Configure logging
log_dir = '/var/log/biosense/'
log_file = os.path.join(log_dir, 'compress-recordings.log')
log_handler = RotatingFileHandler(log_file, maxBytes=1*1024*1024, backupCount=5)  # 1 MB per file, 5 backup files
logging.basicConfig(level=logging.INFO, handlers=[log_handler],
                    format='%(asctime)s - %(levelname)s - %(message)s')

RECORDING_DIR = '/home/biosense/datastore/sound_recordings'

def check_wav_integrity(wav_file):
    try:
        result = subprocess.run(['ffmpeg', '-v', 'error', '-i', wav_file, '-f', 'null', '-'], capture_output=True, text=True)
        if result.returncode != 0 or result.stderr:
            logging.warning(f"Integrity check failed for {wav_file}: {result.stderr.strip()}")
            # Delete the corrupt file after logging
            try:
                os.remove(wav_file)
                logging.info(f"Deleted corrupt .wav file: {wav_file}")
            except Exception as e:
                logging.error(f"Error deleting corrupt .wav file {wav_file}: {e}")
            return False
        return True
    except Exception as e:
        logging.error(f"Error checking integrity of {wav_file}: {e}")
        return False

def convert_to_flac(wav_file, flac_file):
    try:
        subprocess.run(['ffmpeg', '-i', wav_file, flac_file], check=True)
        logging.info(f"Converted {wav_file} to {flac_file}")
    except subprocess.CalledProcessError as e:
        logging.error(f"Error converting {wav_file} to FLAC: {e}")

def scan_and_convert():
    while True:
        logging.info("Scanning for .wav files to convert to .flac")
        current_time = time.time()
        files = os.listdir(RECORDING_DIR)
        wav_files = [f for f in files if f.endswith(".wav")]

        for filename in wav_files:
            filepath = os.path.join(RECORDING_DIR, filename)
            # Check if the file has not been modified in the last 300 seconds
            if current_time - os.path.getmtime(filepath) < 300:
                continue

            flac_file = filepath.replace(".wav", ".flac")
            logging.info(f"Processing file: {filepath}")

            # Check integrity before converting
            if not check_wav_integrity(filepath):
                logging.warning(f"Skipping {filepath} due to integrity issues.")
                continue

            # Convert the file if it passes integrity checks
            convert_to_flac(filepath, flac_file)

            # Optionally, delete the original .wav file after conversion
            try:
                os.remove(filepath)
                logging.info(f"Deleted original .wav file: {filepath}")
            except Exception as e:
                logging.error(f"Error deleting .wav file {filepath}: {e}")

        time.sleep(300)  # Check every 5 minutes

def main():
    logging.info("Starting the WAV to FLAC compression service")
    scan_and_convert()

if __name__ == "__main__":
    main()
