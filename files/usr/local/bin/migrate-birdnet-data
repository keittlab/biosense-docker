#!/usr/bin/env python3

import os
import configparser
from sqlalchemy import create_engine, Column, Integer, String, Float, DateTime
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
from sqlalchemy.exc import SQLAlchemyError
from datetime import datetime
import sys
import logging
from logging.handlers import RotatingFileHandler

# Configure logging
log_dir = '/var/log/biosense/'
log_file = os.path.join(log_dir, 'migrate-birdnet-data.log')
log_handler = RotatingFileHandler(log_file, maxBytes=1*1024*1024, backupCount=5)  # 1 MB per file, 5 backup files
logging.basicConfig(level=logging.INFO, handlers=[log_handler],
                    format='%(asctime)s - %(levelname)s - %(message)s')

# Activate the virtual environment
venv_path = '/home/biosense/biosense_venv/bin/activate_this.py'
if os.path.exists(venv_path):
    with open(venv_path) as file_:
        exec(file_.read(), {'__file__': venv_path})

# Function to read configuration with error handling
def read_config(config_file):
    config = configparser.ConfigParser()
    try:
        config.read(config_file)
        if not config.sections():
            raise Exception("Configuration file is empty or not found.")
        return config
    except Exception as e:
        logging.error(f"Error reading configuration file: {e}")
        sys.exit(1)

# Read configuration
config_file = '/etc/biosense/migrate-birdnet-data.conf'
config = read_config(config_file)

DB_TYPE = config.get('DEFAULT', 'DB_TYPE', fallback='sqlite')
DB_PATH = config.get('DEFAULT', 'DB_PATH', fallback='/home/biosense/datastore/birdnet_results.db')
DB_HOST = config.get('DEFAULT', 'DB_HOST', fallback='10.123.0.1')
DB_PORT = config.getint('DEFAULT', 'DB_PORT', fallback=5432)
DB_NAME = config.get('DEFAULT', 'DB_NAME', fallback='biosense')
DB_USER = config.get('DEFAULT', 'DB_USER', fallback='biosense')
DB_PASSWORD = config.get('DEFAULT', 'DB_PASSWORD', fallback='biosense')

# SQLAlchemy setup
Base = declarative_base()

class Detection(Base):
    __tablename__ = 'birdnet_detections'
    id = Column(Integer, primary_key=True, autoincrement=True)
    sci_name = Column(String, nullable=False)
    com_name = Column(String, nullable=False)
    confidence = Column(Float)
    start_time = Column(Float)
    end_time = Column(Float)
    file_path = Column(String)
    latitude = Column(Float)
    longitude = Column(Float)
    created_at = Column(DateTime, default=datetime.utcnow)

def get_engine(db_type, db_path=None, db_host=None, db_port=None, db_name=None, db_user=None, db_password=None):
    if db_type == 'postgresql':
        return create_engine(f'postgresql+psycopg2://{db_user}:{db_password}@{db_host}:{db_port}/{db_name}')
    else:
        return create_engine(f'sqlite:///{db_path}')

def create_session(engine):
    Session = sessionmaker(bind=engine)
    return Session()

if DB_TYPE == 'postgresql':
    # Create engines and sessions for both SQLite and PostgreSQL
    sqlite_engine = get_engine('sqlite', DB_PATH)
    sqlite_session = create_session(sqlite_engine)
    postgres_engine = get_engine('postgresql', None, DB_HOST, DB_PORT, DB_NAME, DB_USER, DB_PASSWORD)
    postgres_session = create_session(postgres_engine)

    Base.metadata.create_all(sqlite_engine)
    Base.metadata.create_all(postgres_engine)

    def migrate_data():
        try:
            # Check if local SQLite database has data
            count = sqlite_session.query(Detection).count()
            if count == 0:
                logging.info("Local SQLite database is empty. No data to migrate.")
                return

            # Fetch data from SQLite
            sqlite_data = sqlite_session.query(Detection).all()
            if sqlite_data:
                for detection in sqlite_data:
                    postgres_detection = Detection(
                        sci_name=detection.sci_name,
                        com_name=detection.com_name,
                        confidence=detection.confidence,
                        start_time=detection.start_time,
                        end_time=detection.end_time,
                        file_path=detection.file_path,
                        latitude=detection.latitude,
                        longitude=detection.longitude,
                        created_at=detection.created_at
                    )
                    postgres_session.add(postgres_detection)
                postgres_session.commit()
                # Delete data from SQLite after successful migration
                sqlite_session.query(Detection).delete()
                sqlite_session.commit()
                logging.info("Data migrated from SQLite to PostgreSQL")
        except SQLAlchemyError as e:
            logging.error(f"Error during data migration: {e}")
            postgres_session.rollback()
            sqlite_session.rollback()

    if __name__ == "__main__":
        migrate_data()
else:
    if __name__ == "__main__":
        logging.info("Database type is set to SQLite. No migration needed.")
        sys.exit(0)
